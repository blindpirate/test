name: Publish BuildScan Commit Status

on:
  status

permissions:
  statuses: write

jobs:
  check_commit_status:
    runs-on: ubuntu-latest
    steps:
      - name: Handle Commit Status
        uses: actions/github-script@v6
        with:
          script: |
            const commitStatus = context.payload;
            const statusUrl = commitStatus.target_url;
            const state = commitStatus.state;
            const sha = commitStatus.sha;
            const { owner, repo } = context.repo;

            // Check if the URL starts with "https://builds.gradle.org"
            if (!statusUrl || !statusUrl.startsWith("https://builds.gradle.org")) {
              console.log("URL does not start with 'https://builds.gradle.org'. Exiting.");
              return;
            }

            // Define base scan URL
            const baseScanUrl = `https://ge.gradle.org/scans?search.names=gitCommitId&search.rootProjectNames=${repo}`;

            async function setCommitStatus(context, description, scanUrl, state) {
              await github.rest.repos.createCommitStatus({
                owner,
                repo,
                sha,
                state,
                context,
                description,
                target_url: scanUrl,
              });
              console.log(`Published '${context}' status.`);
            }

            if (state === 'success') {
              // Always publish "BuildScanAll" commit status
              const scanUrl = `${baseScanUrl}&search.values=${sha}`;
              await setCommitStatus("BuildScanAll", "Build Scan (All)", scanUrl, "success");
            } else if (state === 'failure') {
              // Always publish "BuildScanFailure" commit status
              const scanUrl = `${baseScanUrl}&search.buildOutcome=failure&search.values=${sha}`;
              await setCommitStatus("BuildScanFailure", "Build Scan (Failure)", scanUrl, "failure");
            }
